create or replace stage azure_stage_creditdata
  url='azure://STORAGEACCOUNTNAME.blob.core.windows.net/DATAFOLDER'
  credentials=(azure_sas_token='<SAS TOKEN>');

create or replace file format customparquet type = parquet;
  
copy into bureau_feature_table
from( 
    SELECT $1:SK_ID_CURR, 
    $1:DEBT_CREDIT_RATIO, 
    $1:CREDIT_DAY_OVERDUE_MEAN,
    $1:DAYS_CREDIT_BETWEEN_MEAN, 
    $1:NUM_CREDIT_COUNT, 
    $1:CREDIT_PROLONG_COUNT,
    $1:ACTIVE_LOANS_PERCENT, 
    $1:"CREDIT_TYPE_Another type of loan",
    $1:"CREDIT_TYPE_Car loan", 
    $1:"CREDIT_TYPE_Cash loan (non-earmarked)",
    $1:"CREDIT_TYPE_Consumer credit", 
    $1:"CREDIT_TYPE_Credit card",
    $1:"CREDIT_TYPE_Interbank credit",
    $1:"CREDIT_TYPE_Loan for business development",
    $1:"CREDIT_TYPE_Loan for purchase of shares (margin lending)",
    $1:"CREDIT_TYPE_Loan for the purchase of equipment",
    $1:"CREDIT_TYPE_Loan for working capital replenishment",
    $1:"CREDIT_TYPE_Microloan", 
    $1:"CREDIT_TYPE_Mobile operator loan",
    $1:"CREDIT_TYPE_Mortgage", 
    $1:"CREDIT_TYPE_Real estate loan",
    $1:"CREDIT_TYPE_Unknown type of loan", 
    $1:"CREDIT_STATUS_EMA_AVG",
    $1:"EVENT_TIMESTAMP"
    FROM @AZURE_STAGE_CREDITDATA (file_format=>customparquet, pattern=>'bureau_feature_table.parquet')
);

copy into previous_loan_features_table
from(
    SELECT
    $1:SK_ID_CURR,
    $1:INSTALMENT_MISSED,
    $1:PERC_UNPAID,
    $1:AMT_UNPAID,
    $1:CREDIT_CARD_BALANCE_EMA_AVG,
    $1:AMT_BALANCE,
    $1:EVENT_TIMESTAMP
    FROM @AZURE_STAGE_CREDITDATA (file_format=>customparquet, pattern=>'previous_loan_features_table.parquet')
);

copy into static_features_table
from(
    SELECT
	$1:EVENT_TIMESTAMP,
	$1:SK_ID_CURR,
	$1:TARGET,
	$1:NAME_CONTRACT_TYPE,
	$1:CODE_GENDER,
	$1:FLAG_OWN_CAR,
	$1:FLAG_OWN_REALTY,
	$1:CNT_CHILDREN,
	$1:AMT_INCOME_TOTAL,
	$1:AMT_CREDIT,
	$1:AMT_ANNUITY,
	$1:AMT_GOODS_PRICE,
	$1:NAME_TYPE_SUITE,
	$1:NAME_INCOME_TYPE,
	$1:NAME_EDUCATION_TYPE,
	$1:NAME_FAMILY_STATUS,
	$1:NAME_HOUSING_TYPE,
	$1:REGION_POPULATION_RELATIVE,
	$1:DAYS_BIRTH,
	$1:DAYS_EMPLOYED,
	$1:DAYS_REGISTRATION,
	$1:DAYS_ID_PUBLISH,
	$1:OWN_CAR_AGE,
	$1:FLAG_MOBIL,
	$1:FLAG_EMP_PHONE,
	$1:FLAG_WORK_PHONE,
	$1:FLAG_CONT_MOBILE,
	$1:FLAG_PHONE,
	$1:FLAG_EMAIL,
	$1:OCCUPATION_TYPE,
	$1:CNT_FAM_MEMBERS,
	$1:REGION_RATING_CLIENT,
	$1:REGION_RATING_CLIENT_W_CITY,
	$1:WEEKDAY_APPR_PROCESS_START,
	$1:HOUR_APPR_PROCESS_START,
	$1:REG_REGION_NOT_LIVE_REGION,
	$1:REG_REGION_NOT_WORK_REGION,
	$1:LIVE_REGION_NOT_WORK_REGION,
	$1:REG_CITY_NOT_LIVE_CITY,
	$1:REG_CITY_NOT_WORK_CITY,
	$1:LIVE_CITY_NOT_WORK_CITY,
	$1:ORGANIZATION_TYPE,
	$1:EXT_SOURCE_1,
	$1:EXT_SOURCE_2,
	$1:EXT_SOURCE_3,
	$1:APARTMENTS_AVG,
	$1:BASEMENTAREA_AVG,
	$1:YEARS_BEGINEXPLUATATION_AVG,
	$1:YEARS_BUILD_AVG,
	$1:COMMONAREA_AVG,
	$1:ELEVATORS_AVG,
	$1:ENTRANCES_AVG,
	$1:FLOORSMAX_AVG,
	$1:FLOORSMIN_AVG,
	$1:LANDAREA_AVG,
	$1:LIVINGAPARTMENTS_AVG,
	$1:LIVINGAREA_AVG,
	$1:NONLIVINGAPARTMENTS_AVG,
	$1:NONLIVINGAREA_AVG,
	$1:APARTMENTS_MODE,
	$1:BASEMENTAREA_MODE,
	$1:YEARS_BEGINEXPLUATATION_MODE,
	$1:YEARS_BUILD_MODE,
	$1:COMMONAREA_MODE,
	$1:ELEVATORS_MODE,
	$1:ENTRANCES_MODE,
	$1:FLOORSMAX_MODE,
	$1:FLOORSMIN_MODE,
	$1:LANDAREA_MODE,
	$1:LIVINGAPARTMENTS_MODE,
	$1:LIVINGAREA_MODE,
	$1:NONLIVINGAPARTMENTS_MODE,
	$1:NONLIVINGAREA_MODE,
	$1:APARTMENTS_MEDI,
	$1:BASEMENTAREA_MEDI,
	$1:YEARS_BEGINEXPLUATATION_MEDI,
	$1:YEARS_BUILD_MEDI,
	$1:COMMONAREA_MEDI,
	$1:ELEVATORS_MEDI,
	$1:ENTRANCES_MEDI,
	$1:FLOORSMAX_MEDI,
	$1:FLOORSMIN_MEDI,
	$1:LANDAREA_MEDI,
	$1:LIVINGAPARTMENTS_MEDI,
	$1:LIVINGAREA_MEDI,
	$1:NONLIVINGAPARTMENTS_MEDI,
	$1:NONLIVINGAREA_MEDI,
	$1:FONDKAPREMONT_MODE,
	$1:HOUSETYPE_MODE,
	$1:TOTALAREA_MODE,
	$1:WALLSMATERIAL_MODE,
	$1:EMERGENCYSTATE_MODE,
	$1:OBS_30_CNT_SOCIAL_CIRCLE,
	$1:DEF_30_CNT_SOCIAL_CIRCLE,
	$1:OBS_60_CNT_SOCIAL_CIRCLE,
	$1:DEF_60_CNT_SOCIAL_CIRCLE,
	$1:DAYS_LAST_PHONE_CHANGE,
	$1:FLAG_DOCUMENT_2,
	$1:FLAG_DOCUMENT_3,
	$1:FLAG_DOCUMENT_4,
	$1:FLAG_DOCUMENT_5,
	$1:FLAG_DOCUMENT_6,
	$1:FLAG_DOCUMENT_7,
	$1:FLAG_DOCUMENT_8,
	$1:FLAG_DOCUMENT_9,
	$1:FLAG_DOCUMENT_10,
	$1:FLAG_DOCUMENT_11,
	$1:FLAG_DOCUMENT_12,
	$1:FLAG_DOCUMENT_13,
	$1:FLAG_DOCUMENT_14,
	$1:FLAG_DOCUMENT_15,
	$1:FLAG_DOCUMENT_16,
	$1:FLAG_DOCUMENT_17,
	$1:FLAG_DOCUMENT_18,
	$1:FLAG_DOCUMENT_19,
	$1:FLAG_DOCUMENT_20,
	$1:FLAG_DOCUMENT_21,
	$1:AMT_REQ_CREDIT_BUREAU_HOUR,
	$1:AMT_REQ_CREDIT_BUREAU_DAY,
	$1:AMT_REQ_CREDIT_BUREAU_WEEK,
	$1:AMT_REQ_CREDIT_BUREAU_MON,
	$1:AMT_REQ_CREDIT_BUREAU_QRT,
	$1:AMT_REQ_CREDIT_BUREAU_YEAR
    FROM @AZURE_STAGE_CREDITDATA (file_format=>customparquet, pattern=>'static_feature_table.parquet')
);